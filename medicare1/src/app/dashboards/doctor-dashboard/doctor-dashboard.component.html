<!-- Include Navbar -->
<app-navbar></app-navbar>

<!-- Main Dashboard Content -->
<div class="container-fluid py-4">
  <div class="container">
    <!-- Welcome Section -->
    <div class="row mb-4">
      <div class="col-12">        <div class="card border-0 shadow-sm bg-light">
          <div class="card-body p-4">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h2 class="card-title mb-2 fw-bold text-dark">Welcome back, Dr. {{ getDoctorName() }}!</h2>
                <p class="card-text mb-0 text-muted">
                  <i class="bi bi-calendar-check me-2"></i>
                  You have {{ getTodayAppointmentsCount() }} appointments today
                  <span class="ms-3">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    {{ getCriticalReportsCount() }} critical lab reports need review
                  </span>
                </p>
              </div>
              <div class="col-md-4 text-md-end">
                <div class="d-flex justify-content-md-end justify-content-start gap-2 mt-3 mt-md-0">
                  <button class="btn btn-primary btn-sm" (click)="openNewAppointmentModal()">
                    <i class="bi bi-calendar-plus me-1"></i>New Appointment
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick Stats Cards -->
    <div class="row mb-4">
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100 dashboard-card stats-card">
          <div class="card-body text-center">
            <div class="bg-primary bg-opacity-10 p-3 rounded-circle d-inline-block mb-3">
              <i class="bi bi-calendar-event text-primary fs-3"></i>
            </div>
            <h4 class="card-title fw-bold mb-1">{{ getTodayAppointmentsCount() }}</h4>
            <p class="card-text text-muted small mb-0">Today's Appointments</p>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100 dashboard-card stats-card">
          <div class="card-body text-center">
            <div class="bg-success bg-opacity-10 p-3 rounded-circle d-inline-block mb-3">
              <i class="bi bi-file-medical text-success fs-3"></i>
            </div>
            <h4 class="card-title fw-bold mb-1">{{ getUnreviewedReportsCount() }}</h4>
            <p class="card-text text-muted small mb-0">Unreviewed Reports</p>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100 dashboard-card stats-card">
          <div class="card-body text-center">
            <div class="bg-danger bg-opacity-10 p-3 rounded-circle d-inline-block mb-3">
              <i class="bi bi-exclamation-triangle text-danger fs-3"></i>
            </div>
            <h4 class="card-title fw-bold mb-1">{{ getCriticalReportsCount() }}</h4>
            <p class="card-text text-muted small mb-0">Critical Reports</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Tabs -->
    <div class="row">
      <div class="col-12">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-bottom">
            <ul class="nav nav-tabs card-header-tabs" id="dashboardTabs" role="tablist">              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="appointments-tab" data-bs-toggle="tab" data-bs-target="#appointments" 
                        type="button" role="tab" aria-controls="appointments" aria-selected="true">
                  <i class="bi bi-calendar-event me-2"></i>Appointments
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="lab-reports-tab" data-bs-toggle="tab" data-bs-target="#lab-reports" 
                        type="button" role="tab" aria-controls="lab-reports" aria-selected="false">
                  <i class="bi bi-file-medical me-2"></i>Lab Reports
                </button>
              </li>              <li class="nav-item" role="presentation">
                <button class="nav-link" id="patient-records-tab" data-bs-toggle="tab" data-bs-target="#patient-records" 
                        type="button" role="tab" aria-controls="patient-records" aria-selected="false">
                  <i class="bi bi-person-lines-fill me-2"></i>Patient Records
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="add-patient-record-tab" data-bs-toggle="tab" data-bs-target="#add-patient-record" 
                        type="button" role="tab" aria-controls="add-patient-record" aria-selected="false">
                  <i class="bi bi-person-plus me-2"></i>Add Patient Record
                </button>
              </li>
            </ul>
          </div>
          <div class="card-body">
            <div class="tab-content" id="dashboardTabContent">
              
              <!-- Appointments Tab -->
              <div class="tab-pane fade show active tab-content-section" id="appointments" role="tabpanel" 
                   aria-labelledby="appointments-tab">                <div class="row mb-3">
                  <div class="col-md-8">
                    <h5 class="mb-0">Appointment Requests</h5>
                    <small class="text-muted">Review and approve patient appointment requests</small>
                  </div>
                  <div class="col-md-4 text-end">
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary" 
                              [class.active]="selectedDate === 'pending'" (click)="filterAppointmentsByDate('pending')">
                        Pending
                      </button>
                      <button type="button" class="btn btn-outline-primary" 
                              [class.active]="selectedDate === 'approved'" (click)="filterAppointmentsByDate('approved')">
                        Approved
                      </button>
                      <button type="button" class="btn btn-outline-primary" 
                              [class.active]="selectedDate === 'all'" (click)="filterAppointmentsByDate('all')">
                        All
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-12">
                    <div class="appointments-list">
                      <div *ngFor="let appointment of getFilteredAppointments()" 
                           class="card appointment-card mb-3 border-start border-4"
                           [ngClass]="{
                             'border-success': appointment.status === 'completed',
                             'border-primary': appointment.status === 'scheduled',
                             'border-danger': appointment.status === 'cancelled'
                           }">
                        <div class="card-body">
                          <div class="row align-items-center">
                            <div class="col-md-6">
                              <h6 class="card-title mb-1 fw-bold">{{ appointment.patientName }}</h6>
                              <p class="card-text small text-muted mb-2">
                                <i class="bi bi-calendar me-1"></i>{{ formatDate(appointment.date) }}
                                <i class="bi bi-clock ms-3 me-1"></i>{{ appointment.time }}
                              </p>
                              <span class="badge" 
                                    [ngClass]="{
                                      'bg-primary': appointment.type === 'consultation',
                                      'bg-info': appointment.type === 'follow-up',
                                      'bg-danger': appointment.type === 'emergency'
                                    }">
                                {{ appointment.type | titlecase }}
                              </span>
                            </div>                            <div class="col-md-3">
                              <span class="badge fs-6" 
                                    [ngClass]="{
                                      'bg-warning': appointment.status === 'pending',
                                      'bg-success': appointment.status === 'approved',
                                      'bg-primary': appointment.status === 'scheduled',
                                      'bg-danger': appointment.status === 'rejected'
                                    }">
                                {{ appointment.status | titlecase }}
                              </span>
                            </div>
                            <div class="col-md-3 text-end">
                              <div class="btn-group btn-group-sm" *ngIf="appointment.status === 'pending'">
                                <button class="btn btn-success btn-sm" 
                                        (click)="approveAppointment(appointment.id)"
                                        title="Approve appointment">
                                  <i class="bi bi-check-lg"></i> Approve
                                </button>
                                <button class="btn btn-outline-danger btn-sm" 
                                        (click)="rejectAppointment(appointment.id)"
                                        title="Reject appointment">
                                  <i class="bi bi-x-lg"></i> Reject
                                </button>
                              </div>
                              <div class="btn-group btn-group-sm" *ngIf="appointment.status !== 'pending'">
                                <button class="btn btn-outline-primary btn-sm" 
                                        (click)="openAppointmentModal(appointment)"
                                        title="View details">
                                  <i class="bi bi-eye"></i>
                                </button>
                                <button class="btn btn-outline-secondary btn-sm" 
                                        (click)="rescheduleAppointment(appointment.id)"
                                        title="Reschedule"
                                        *ngIf="appointment.status === 'approved'">
                                  <i class="bi bi-calendar-event"></i>
                                </button>
                              </div>
                            </div>
                          </div>
                          <div *ngIf="appointment.notes" class="mt-2">
                            <small class="text-muted">
                              <strong>Notes:</strong> {{ appointment.notes }}
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>              <!-- Lab Reports Tab -->
              <div class="tab-pane fade tab-content-section" id="lab-reports" role="tabpanel" 
                   aria-labelledby="lab-reports-tab">
                <div class="row mb-3">
                  <div class="col-md-8">
                    <h5 class="mb-0">Lab Reports</h5>
                  </div>
                  <div class="col-md-4 text-end">
                    <div class="btn-group btn-group-sm" role="group">
                      <button type="button" class="btn btn-outline-primary" 
                              [class.active]="reportFilter === 'all'" (click)="filterReports('all')">
                        All
                      </button>
                      <button type="button" class="btn btn-outline-warning" 
                              [class.active]="reportFilter === 'unreviewed'" (click)="filterReports('unreviewed')">
                        Unreviewed
                      </button>
                      <button type="button" class="btn btn-outline-danger" 
                              [class.active]="reportFilter === 'critical'" (click)="filterReports('critical')">
                        Critical
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-12">
                    <div *ngFor="let report of getFilteredLabReports()" 
                         class="card lab-report-card mb-3 border-start border-4"
                         [ngClass]="{
                           'border-danger': report.status === 'critical',
                           'border-warning': report.status === 'abnormal',
                           'border-success': report.status === 'normal'
                         }">
                      <div class="card-body">
                        <div class="row align-items-center">
                          <div class="col-md-8">
                            <div class="d-flex align-items-center mb-2">
                              <h6 class="card-title mb-0 fw-bold me-3">{{ report.patientName }}</h6>
                              <span class="badge" 
                                    [ngClass]="{
                                      'bg-danger': report.status === 'critical',
                                      'bg-warning': report.status === 'abnormal',
                                      'bg-success': report.status === 'normal'
                                    }">
                                {{ report.status | titlecase }}
                              </span>
                              <span *ngIf="!report.reviewed" class="badge bg-warning ms-2">
                                Unreviewed
                              </span>
                            </div>
                            <p class="card-text small text-muted mb-2">
                              <i class="bi bi-calendar me-1"></i>{{ formatDate(report.date) }}
                            </p>
                            <div class="row">
                              <div class="col-md-4">
                                <small><strong>Test:</strong> {{ report.testName }}</small>
                              </div>
                              <div class="col-md-4">
                                <small><strong>Result:</strong> {{ report.result }}</small>
                              </div>
                              <div class="col-md-4">
                                <small><strong>Normal Range:</strong> {{ report.normalRange }}</small>
                              </div>
                            </div>
                          </div>
                          <div class="col-md-4 text-end">
                            <div class="btn-group btn-group-sm">
                              <button class="btn btn-outline-primary btn-sm" 
                                      (click)="viewLabReport(report)">
                                <i class="bi bi-eye me-1"></i>View
                              </button>
                              <button *ngIf="!report.reviewed" 
                                      class="btn btn-success btn-sm" 
                                      (click)="markAsReviewed(report.id)">
                                <i class="bi bi-check-lg me-1"></i>Mark Reviewed
                              </button>
                              <button class="btn btn-outline-secondary btn-sm" 
                                      (click)="downloadReport(report.id)">
                                <i class="bi bi-download"></i>
                              </button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Patient Records Tab -->
              <div class="tab-pane fade tab-content-section" id="patient-records" role="tabpanel" 
                   aria-labelledby="patient-records-tab">
                <div class="row mb-3">
                  <div class="col-md-8">
                    <h5 class="mb-0">Patient Medical Records</h5>
                  </div>
                  <div class="col-md-4">
                    <div class="input-group input-group-sm">
                      <input type="text" class="form-control" placeholder="Search patients..." 
                             [(ngModel)]="patientSearchTerm" (input)="searchPatients()">
                      <button class="btn btn-outline-secondary" type="button">
                        <i class="bi bi-search"></i>
                      </button>
                    </div>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-12">
                    <div *ngFor="let record of filteredPatientRecords" 
                         class="card patient-record-card mb-3">
                      <div class="card-body">
                        <div class="row align-items-center">
                          <div class="col-md-8">
                            <h6 class="card-title mb-1 fw-bold">
                              {{ record.user?.firstName }} {{ record.user?.lastName }}
                            </h6>
                            <p class="card-text small text-muted mb-2">
                              <i class="bi bi-envelope me-1"></i>{{ record.user?.email }}
                              <i class="bi bi-telephone ms-3 me-1"></i>{{ record.user?.phoneNumber }}
                            </p>                            <div class="row">
                              <div class="col-md-6">
                                <small><strong>Visit Date:</strong> {{ formatDate(record.visitDate) }}</small>
                              </div>
                              <div class="col-md-6">
                                <small><strong>Doctor:</strong> {{ record.doctor }}</small>
                              </div>
                            </div>
                            <div *ngIf="record.condition" class="mt-2">
                              <small class="text-muted">
                                <strong>Condition:</strong> {{ record.condition }}
                              </small>
                            </div>
                          </div>
                          <div class="col-md-4 text-end">
                            <div class="btn-group btn-group-sm">
                              <button class="btn btn-primary btn-sm" 
                                      (click)="openMedicalRecordModal(record)">
                                <i class="bi bi-eye me-1"></i>View Full Record
                              </button>                              <button class="btn btn-outline-secondary btn-sm" 
                                      (click)="downloadMedicalRecord(record)">
                                <i class="bi bi-download"></i>
                              </button>
                            </div>                    </div>
                  </div>
                </div>
              </div>

              <!-- Add Patient Record Tab -->
              <div class="tab-pane fade tab-content-section" id="add-patient-record" role="tabpanel" 
                   aria-labelledby="add-patient-record-tab">
                <div class="row mb-3">
                  <div class="col-md-8">
                    <h5 class="mb-0">Add New Patient Record</h5>
                    <small class="text-muted">Create a new medical record for a patient</small>
                  </div>
                </div>
                
                <div class="row">
                  <div class="col-12">
                    <form (ngSubmit)="savePatientRecord()" #patientRecordForm="ngForm">
                      <div class="card">
                        <div class="card-header">
                          <h6 class="mb-0"><i class="bi bi-person-fill me-2"></i>Patient Information</h6>
                        </div>
                        <div class="card-body">
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <label for="patientSelect" class="form-label">Select Patient *</label>
                              <select class="form-select" id="patientSelect" 
                                      [(ngModel)]="newPatientRecord.patientId" 
                                      name="patientSelect" required>
                                <option value="">Choose a patient...</option>
                                <option *ngFor="let patient of patients" [value]="patient.id">
                                  {{ patient.firstName }} {{ patient.lastName }} - {{ patient.email }}
                                </option>
                              </select>
                            </div>
                            <div class="col-md-6 mb-3">
                              <label for="visitDate" class="form-label">Visit Date *</label>
                              <input type="date" class="form-control" id="visitDate" 
                                     [(ngModel)]="newPatientRecord.visitDate" 
                                     name="visitDate" required>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <label for="visitTime" class="form-label">Visit Time *</label>
                              <input type="time" class="form-control" id="visitTime" 
                                     [(ngModel)]="newPatientRecord.visitTime" 
                                     name="visitTime" required>
                            </div>
                            <div class="col-md-6 mb-3">
                              <label for="doctorName" class="form-label">Doctor *</label>
                              <input type="text" class="form-control" id="doctorName" 
                                     [(ngModel)]="newPatientRecord.doctor" 
                                     name="doctorName" 
                                     [value]="getDoctorName()" 
                                     readonly>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="card mt-3">
                        <div class="card-header">
                          <h6 class="mb-0"><i class="bi bi-clipboard-heart me-2"></i>Medical Information</h6>
                        </div>
                        <div class="card-body">
                          <div class="row">
                            <div class="col-12 mb-3">
                              <label for="condition" class="form-label">Condition/Diagnosis *</label>
                              <textarea class="form-control" id="condition" rows="3" 
                                        [(ngModel)]="newPatientRecord.condition" 
                                        name="condition" 
                                        placeholder="Enter patient's condition or diagnosis..."
                                        required></textarea>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <label for="medicines" class="form-label">Medicines</label>                              <textarea class="form-control" id="medicines" rows="4" 
                                        [(ngModel)]="medicationsText" 
                                        name="medicines" 
                                        placeholder="Enter medicines separated by commas (e.g., Paracetamol 500mg, Ibuprofen 200mg)"></textarea>
                              <small class="form-text text-muted">Separate multiple medicines with commas</small>
                            </div>
                            <div class="col-md-6 mb-3">
                              <label for="labTests" class="form-label">Lab Tests</label>
                              <textarea class="form-control" id="labTests" rows="4" 
                                        [(ngModel)]="labTestsText" 
                                        name="labTests" 
                                        placeholder="Enter lab tests separated by commas (e.g., Blood Sugar, CBC, X-Ray)"></textarea>
                              <small class="form-text text-muted">Separate multiple tests with commas</small>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-12 mb-3">
                              <label for="notes" class="form-label">Additional Notes</label>
                              <textarea class="form-control" id="notes" rows="3" 
                                        [(ngModel)]="newPatientRecord.notes" 
                                        name="notes" 
                                        placeholder="Any additional notes or observations..."></textarea>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-md-6 mb-3">
                              <label for="status" class="form-label">Status</label>
                              <select class="form-select" id="status" 
                                      [(ngModel)]="newPatientRecord.status" 
                                      name="status">
                                <option value="active">Active</option>
                                <option value="completed">Completed</option>
                                <option value="follow-up">Follow-up Required</option>
                              </select>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="row mt-4">
                        <div class="col-12">
                          <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" (click)="resetForm()">
                              <i class="bi bi-arrow-clockwise me-1"></i>Reset Form
                            </button>
                            <button type="submit" class="btn btn-primary" [disabled]="!patientRecordForm.form.valid || isLoading">
                              <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                              <i class="bi bi-save me-1" *ngIf="!isLoading"></i>Save Patient Record
                            </button>
                          </div>
                        </div>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Appointment Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1" aria-labelledby="appointmentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="appointmentModalLabel">
          {{ isEditingAppointment ? 'Edit Appointment' : 'New Appointment' }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="patientName" class="form-label">Patient Name</label>
              <input type="text" class="form-control" id="patientName" 
                     [(ngModel)]="selectedAppointment.patientName" name="patientName">
            </div>
            <div class="col-md-6 mb-3">
              <label for="appointmentDate" class="form-label">Date</label>
              <input type="date" class="form-control" id="appointmentDate" 
                     [(ngModel)]="selectedAppointment.date" name="appointmentDate">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="appointmentTime" class="form-label">Time</label>
              <input type="time" class="form-control" id="appointmentTime" 
                     [(ngModel)]="selectedAppointment.time" name="appointmentTime">
            </div>
            <div class="col-md-6 mb-3">
              <label for="appointmentType" class="form-label">Type</label>
              <select class="form-select" id="appointmentType" 
                      [(ngModel)]="selectedAppointment.type" name="appointmentType">
                <option value="consultation">Consultation</option>
                <option value="follow-up">Follow-up</option>
                <option value="emergency">Emergency</option>
              </select>
            </div>
          </div>
          <div class="mb-3">
            <label for="appointmentNotes" class="form-label">Notes</label>
            <textarea class="form-control" id="appointmentNotes" rows="3" 
                      [(ngModel)]="selectedAppointment.notes" name="appointmentNotes"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="saveAppointment()">
          {{ isEditingAppointment ? 'Update' : 'Create' }}
        </button>
      </div>
    </div>
  </div>
</div>


<!-- Medical Record Modal -->
<div class="modal fade" id="medicalRecordModal" tabindex="-1" aria-labelledby="medicalRecordModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="medicalRecordModalLabel">
          Medical Record - {{ selectedMedicalRecord?.user?.firstName }} {{ selectedMedicalRecord?.user?.lastName }}
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div *ngIf="selectedMedicalRecord" class="row">
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">Patient Information</h6>
            <table class="table table-sm">
              <tr>
                <td><strong>Name:</strong></td>
                <td>{{ selectedMedicalRecord.user?.firstName }} {{ selectedMedicalRecord.user?.lastName }}</td>
              </tr>
              <tr>
                <td><strong>Email:</strong></td>
                <td>{{ selectedMedicalRecord.user?.email }}</td>
              </tr>
              <tr>
                <td><strong>Phone:</strong></td>
                <td>{{ selectedMedicalRecord.user?.phoneNumber }}</td>
              </tr>              <tr>
                <td><strong>Visit Date:</strong></td>
                <td>{{ formatDate(selectedMedicalRecord.visitDate) }}</td>
              </tr>
              <tr>
                <td><strong>Doctor:</strong></td>
                <td>{{ selectedMedicalRecord.doctor }}</td>
              </tr>
            </table>
          </div>
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">Medical Information</h6>            <div class="mb-3">
              <strong>Condition:</strong>
              <p class="mt-1">{{ selectedMedicalRecord.condition || 'No condition recorded' }}</p>
            </div>
            <div class="mb-3">
              <strong>Prescription:</strong>
              <p class="mt-1">{{ selectedMedicalRecord.prescription || 'No prescription recorded' }}</p>
            </div>
            <div class="mb-3">
              <strong>Lab Tests:</strong>
              <p class="mt-1">{{ selectedMedicalRecord.labTest?.join(', ') || 'No lab tests ordered' }}</p>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-outline-primary" (click)="editMedicalRecord()">
          <i class="bi bi-pencil me-1"></i>Edit Record
        </button>        <button type="button" class="btn btn-primary" (click)="downloadMedicalRecord(selectedMedicalRecord)">
          <i class="bi bi-download me-1"></i>Download
        </button>
      </div>
    </div>
  </div>
</div>
